# çŠ¶æ€æ è¿‡æ»¤é—®é¢˜ä¿®å¤è®¡åˆ’

## é—®é¢˜æ¦‚è¿°

ç”¨æˆ·å¸Œæœ›åœ¨ `~/.claude/hud/statusline-command.sh` ä¸­è¿‡æ»¤ OMC è¾“å‡ºçš„ä¸¤ä¸ªéƒ¨åˆ†ï¼š
1. `[OMC] | ` å‰ç¼€
2. `ğŸŸ¢ ~$0.0439 | ` æˆæœ¬æ˜¾ç¤ºéƒ¨åˆ†

### å½“å‰è¾“å‡º
```
[OMC] | session:12m | ğŸŸ¢ ~$0.0439 | 4.3k | Cache: 83.1% | $0.21/h | ultrawork | ctx:2%
```

### æœŸæœ›è¾“å‡º
```
session:12m | 4.3k | Cache: 83.1% | $0.21/h | ultrawork | ctx:2%
```

---

## æ ¹å› åˆ†æ

### 1. ANSI è½¬ä¹‰åºåˆ—çš„ç²¾ç¡®æ ¼å¼

é€šè¿‡åˆ†ææºç  `colors.js`ï¼Œç¡®è®¤ï¼š

```javascript
const BOLD = '\x1b[1m';
const RESET = '\x1b[0m';
const DIM = '\x1b[2m';

export function bold(text) {
    return `${BOLD}${text}${RESET}`;
}

export function dim(text) {
    return `${DIM}${text}${RESET}`;
}
```

`render.js` ç¬¬ 60-61 è¡Œï¼š
```javascript
if (enabledElements.omcLabel) {
    elements.push(bold('[OMC]'));
}
```

ç¬¬ 160 è¡Œï¼Œå…ƒç´ è¿æ¥æ–¹å¼ï¼š
```javascript
const headerLine = elements.join(dim(' | '));
```

### 2. å®é™…è¾“å‡ºçš„ç²¾ç¡®å­—èŠ‚åºåˆ—

#### 2.1 `[OMC] | ` éƒ¨åˆ†

`[OMC] | ` éƒ¨åˆ†çš„å®é™…æ ¼å¼æ˜¯ï¼š
```
\x1b[1m[OMC]\x1b[0m\x1b[2m | \x1b[0m
```

åˆ†è§£ï¼š
- `\x1b[1m` - åŠ ç²—å¼€å§‹
- `[OMC]` - æ–‡æœ¬
- `\x1b[0m` - é‡ç½®
- `\x1b[2m` - æš—æ·¡å¼€å§‹ï¼ˆåˆ†éš”ç¬¦æ ·å¼ï¼‰
- ` | ` - åˆ†éš”ç¬¦æ–‡æœ¬
- `\x1b[0m` - é‡ç½®

#### 2.2 æˆæœ¬æ˜¾ç¤ºéƒ¨åˆ†ï¼ˆCritical Issue ä¿®å¤ï¼‰

é€šè¿‡åˆ†æ `analytics-display.js` ç¬¬ 111-122 è¡Œçš„ `renderSessionHealthAnalytics` å‡½æ•°ï¼š

```javascript
const costIndicator = sessionHealth.health === 'critical' ? 'ğŸ”´' :
    sessionHealth.health === 'warning' ? 'ğŸŸ¡' : 'ğŸŸ¢';
const costPrefix = sessionHealth.isEstimated ? '~' : '';
const cost = `${costPrefix}$${(sessionHealth.sessionCost ?? 0).toFixed(4)}`;
return `${costIndicator} ${cost} | ${tokens} | Cache: ${cacheRate}%${costHour}`;
```

**å…³é”®å‘ç°**ï¼š
- emojiï¼ˆğŸŸ¢/ğŸŸ¡/ğŸ”´ï¼‰æ˜¯**çº¯æ–‡æœ¬**ï¼Œæ—  ANSI é¢œè‰²ä»£ç 
- æˆæœ¬é‡‘é¢ï¼ˆ`~$0.0439` æˆ– `$0.0439`ï¼‰æ˜¯**çº¯æ–‡æœ¬**ï¼Œæ—  ANSI é¢œè‰²ä»£ç 
- `~` å‰ç¼€ä»…åœ¨ `isEstimated=true` æ—¶å‡ºç°
- åˆ†éš”ç¬¦ ` | ` åœ¨æˆæœ¬æ˜¾ç¤ºåæ˜¯çº¯æ–‡æœ¬ï¼ˆä¸ `[OMC]` åçš„ dim æ ·å¼åˆ†éš”ç¬¦ä¸åŒï¼‰

æˆæœ¬æ˜¾ç¤ºçš„å®é™…æ ¼å¼æ˜¯ï¼š
```
ğŸŸ¢ ~$0.0439 |
```
æˆ–ï¼ˆæ— ä¼°ç®—å‰ç¼€æ—¶ï¼‰ï¼š
```
ğŸŸ¢ $0.0439 |
```

**æ³¨æ„**ï¼šå­˜åœ¨ä¸‰ç§çŠ¶æ€ emojiï¼š
- `ğŸŸ¢` - healthyï¼ˆç»¿è‰²ï¼‰
- `ğŸŸ¡` - warningï¼ˆé»„è‰²ï¼‰
- `ğŸ”´` - criticalï¼ˆçº¢è‰²ï¼‰

### 3. ä¹‹å‰æ–¹æ¡ˆå¤±è´¥çš„åŸå› 

å½“å‰ä»£ç ï¼ˆç¬¬ 98 è¡Œï¼‰ï¼š
```bash
filtered_output=$(echo "$omc_output" | sed $'s/\\x1b\\\\[[0-9;]*m\\\\[OMC\\\\]\\x1b\\\\[[0-9;]*m | //')
```

**é—®é¢˜**ï¼š
1. åˆ†éš”ç¬¦ ` | ` æœ¬èº«ä¹Ÿè¢« ANSI ä»£ç åŒ…è£¹ï¼ˆdim æ ·å¼ï¼‰
2. æ­£åˆ™è¡¨è¾¾å¼æ²¡æœ‰åŒ¹é…åˆ†éš”ç¬¦çš„ ANSI ä»£ç 
3. sed çš„è½¬ä¹‰è¯­æ³•åœ¨ bash ä¸­å®¹æ˜“å‡ºé”™

---

## è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šä½¿ç”¨ Perl è¿›è¡Œç²¾ç¡®åŒ¹é…ï¼ˆæ¨èï¼‰

Perl å¯¹ ANSI è½¬ä¹‰åºåˆ—æœ‰æ›´å¥½çš„æ”¯æŒï¼Œä¸”è¯­æ³•æ›´æ¸…æ™°ï¼š

```bash
# è¿‡æ»¤ [OMC] åŠå…¶åçš„åˆ†éš”ç¬¦ï¼Œä»¥åŠæˆæœ¬æ˜¾ç¤º
filtered_output=$(echo "$omc_output" | perl -pe '
  # ç§»é™¤ [OMC] æ ‡ç­¾ï¼ˆå¸¦ ANSI åŠ ç²—ï¼‰åŠå…¶åçš„åˆ†éš”ç¬¦ï¼ˆå¸¦ ANSI æš—æ·¡ï¼‰
  s/\e\[1m\[OMC\]\e\[0m\e\[2m \| \e\[0m//;
  # ç§»é™¤æˆæœ¬æ˜¾ç¤ºï¼šğŸŸ¢/ğŸŸ¡/ğŸ”´ åè·Ÿå¯é€‰çš„~å’Œ$é‡‘é¢ï¼Œä»¥åŠåˆ†éš”ç¬¦
  s/[ğŸŸ¢ğŸŸ¡ğŸ”´] ~?\$[\d.]+ \| //;
')
```

### æ–¹æ¡ˆ Bï¼šå…ˆç§»é™¤æ‰€æœ‰ ANSIï¼Œå†è¿‡æ»¤ï¼Œæœ€åæ¢å¤å…³é”®æ ·å¼

å¦‚æœéœ€è¦ä¿ç•™å…¶ä»–å…ƒç´ çš„æ ·å¼ï¼Œè¿™ä¸ªæ–¹æ¡ˆæ›´å¤æ‚ä½†æ›´å¥å£®ï¼š

```bash
# ç§»é™¤æ‰€æœ‰ ANSI è½¬ä¹‰åºåˆ—åè¿›è¡Œçº¯æ–‡æœ¬è¿‡æ»¤
filtered_output=$(echo "$omc_output" | \
  sed 's/\x1b\[[0-9;]*m//g' | \
  sed 's/\[OMC\] | //; s/[ğŸŸ¢ğŸ”´] ~\$[0-9.]* | //')
```

**æ³¨æ„**ï¼šæ­¤æ–¹æ¡ˆä¼šç§»é™¤æ‰€æœ‰é¢œè‰²æ ·å¼ã€‚

### æ–¹æ¡ˆ Cï¼šä½¿ç”¨ awk è¿›è¡Œå­—æ®µçº§å¤„ç†

```bash
filtered_output=$(echo "$omc_output" | awk -F ' \\| ' '{
  out = ""
  for (i = 1; i <= NF; i++) {
    # è·³è¿‡ [OMC] å­—æ®µå’Œæˆæœ¬å­—æ®µ
    if ($i ~ /\[OMC\]/ || $i ~ /~\$[0-9.]+/) continue
    if (out != "") out = out " | "
    out = out $i
  }
  print out
}')
```

---

## æ¨èå®æ–½æ–¹æ¡ˆ

é‡‡ç”¨ **æ–¹æ¡ˆ Aï¼ˆPerlï¼‰**ï¼ŒåŸå› ï¼š
1. macOS è‡ªå¸¦ Perlï¼Œæ— éœ€é¢å¤–å®‰è£…
2. Perl æ­£åˆ™è¡¨è¾¾å¼å¯¹ `\e` è½¬ä¹‰æœ‰åŸç”Ÿæ”¯æŒ
3. ä»£ç å¯è¯»æ€§å¥½ï¼Œæ˜“äºç»´æŠ¤

---

## å…·ä½“å®æ–½æ­¥éª¤

### TODO 1: ä¿®æ”¹ statusline-command.sh

**æ–‡ä»¶**: `~/.claude/hud/statusline-command.sh`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 95-100 è¡Œ

**å½“å‰ä»£ç **:
```bash
# ç¬¬äºŒè¡Œï¼šOMCï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰- è¿‡æ»¤æ‰ä¸éœ€è¦çš„éƒ¨åˆ†
if [ -n "$omc_output" ]; then
  # å…ˆç§»é™¤æ‰€æœ‰ ANSI è½¬ä¹‰åºåˆ—åŒ…è£¹çš„ [OMC] | éƒ¨åˆ†ï¼Œå†ç§»é™¤æˆæœ¬æ˜¾ç¤º
  # ANSI æ ¼å¼: \x1b[1m[OMC]\x1b[0m |
  filtered_output=$(echo "$omc_output" | sed $'s/\\x1b\\\\[[0-9;]*m\\\\[OMC\\\\]\\x1b\\\\[[0-9;]*m | //; s/[ğŸŸ¢ğŸ”´] ~\\\\$[0-9.]* | //')
  echo "$filtered_output"
fi
```

**æ›¿æ¢ä¸º**:
```bash
# ç¬¬äºŒè¡Œï¼šOMCï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰- è¿‡æ»¤æ‰ä¸éœ€è¦çš„éƒ¨åˆ†
if [ -n "$omc_output" ]; then
  # ä½¿ç”¨ Perl è¿‡æ»¤ï¼š
  # 1. ç§»é™¤ [OMC] æ ‡ç­¾ï¼ˆ\e[1måŠ ç²—ï¼‰åŠåç»­åˆ†éš”ç¬¦ï¼ˆ\e[2mæš—æ·¡ï¼‰
  # 2. ç§»é™¤æˆæœ¬æ˜¾ç¤ºï¼ˆğŸŸ¢/ğŸŸ¡/ğŸ”´ + å¯é€‰~å‰ç¼€ + $é‡‘é¢ + åˆ†éš”ç¬¦ï¼‰
  filtered_output=$(echo "$omc_output" | perl -pe '
    s/\e\[1m\[OMC\]\e\[0m\e\[2m \| \e\[0m//;
    s/[ğŸŸ¢ğŸŸ¡ğŸ”´] ~?\$[\d.]+ \| //;
  ')
  echo "$filtered_output"
fi
```

### TODO 2: éªŒè¯ä¿®æ”¹

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯ï¼š

```bash
# æµ‹è¯•è¿‡æ»¤æ•ˆæœï¼ˆåŒ…å«æ‰€æœ‰ä¸‰ç§ emoji çŠ¶æ€ï¼‰
echo $'\e[1m[OMC]\e[0m\e[2m | \e[0msession:12m | ğŸŸ¢ ~$0.0439 | 4.3k | Cache: 83.1%' | perl -pe '
  s/\e\[1m\[OMC\]\e\[0m\e\[2m \| \e\[0m//;
  s/[ğŸŸ¢ğŸŸ¡ğŸ”´] ~?\$[\d.]+ \| //;
'
```

**é¢„æœŸè¾“å‡º**:
```
session:12m | 4.3k | Cache: 83.1%
```

**é¢å¤–æµ‹è¯•ç”¨ä¾‹**ï¼ˆéªŒè¯æ—  ~ å‰ç¼€å’Œä¸åŒ emojiï¼‰:
```bash
# æµ‹è¯•æ— ä¼°ç®—å‰ç¼€
echo 'ğŸŸ¡ $1.2345 | tokens' | perl -pe 's/[ğŸŸ¢ğŸŸ¡ğŸ”´] ~?\$[\d.]+ \| //'
# é¢„æœŸè¾“å‡º: tokens

# æµ‹è¯• critical çŠ¶æ€
echo 'ğŸ”´ ~$5.0000 | warning' | perl -pe 's/[ğŸŸ¢ğŸŸ¡ğŸ”´] ~?\$[\d.]+ \| //'
# é¢„æœŸè¾“å‡º: warning
```

---

## éªŒæ”¶æ ‡å‡†

| æ ‡å‡† | éªŒè¯æ–¹æ³• |
|------|----------|
| `[OMC] \| ` å‰ç¼€è¢«ç§»é™¤ | è¾“å‡ºä¸åŒ…å« `[OMC]` |
| æˆæœ¬æ˜¾ç¤ºè¢«ç§»é™¤ | è¾“å‡ºä¸åŒ…å« `~$` é‡‘é¢ |
| å…¶ä»–å…ƒç´ ä¿æŒä¸å˜ | sessionã€Cacheã€ctx ç­‰æ­£å¸¸æ˜¾ç¤º |
| ANSI é¢œè‰²æ­£å¸¸ | ç»ˆç«¯ä¸­é¢œè‰²æ˜¾ç¤ºæ­£ç¡® |

---

## é£é™©ä¸å¤‡é€‰æ–¹æ¡ˆ

### é£é™© 1: OMC æ’ä»¶æ›´æ–°åæ ¼å¼å˜åŒ–

**ç¼“è§£**:
- æ–¹æ¡ˆ A çš„æ­£åˆ™è¡¨è¾¾å¼ç²¾ç¡®åŒ¹é…å½“å‰æ ¼å¼
- å¦‚æ ¼å¼å˜åŒ–ï¼Œéœ€é‡æ–°åˆ†æ `render.js` å’Œ `colors.js`

### é£é™© 2: Perl ä¸å¯ç”¨

**å¤‡é€‰**: ä½¿ç”¨æ–¹æ¡ˆ Bï¼ˆçº¯ sed ç§»é™¤æ‰€æœ‰ ANSIï¼‰

```bash
filtered_output=$(echo "$omc_output" | \
  sed 's/\x1b\[[0-9;]*m//g' | \
  sed 's/\[OMC\] | //; s/[ğŸŸ¢ğŸŸ¡ğŸ”´] ~\{0,1\}\$[0-9.]* | //')
```

### é£é™© 3: æˆæœ¬æ˜¾ç¤ºæ ¼å¼å˜åŒ–ï¼ˆå¦‚è´Ÿæ•°ã€æ›´å¤§é‡‘é¢ï¼‰

**ç¼“è§£**: å½“å‰æ­£åˆ™ `~\$[\d.]+` å¯åŒ¹é…ä»»æ„æ­£æ•°é‡‘é¢ï¼Œå¦‚éœ€åŒ¹é…è´Ÿæ•°å¯æ”¹ä¸º `~-?\$[\d.]+`

---

## æäº¤ç­–ç•¥

```bash
git add ~/.claude/hud/statusline-command.sh
git commit -m "fix(hud): ä¿®å¤ OMC çŠ¶æ€æ è¿‡æ»¤é€»è¾‘

ä½¿ç”¨ Perl æ­£ç¡®å¤„ç† ANSI è½¬ä¹‰åºåˆ—ï¼Œè¿‡æ»¤ [OMC] å‰ç¼€å’Œæˆæœ¬æ˜¾ç¤º

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

---

## æˆåŠŸæ ‡å‡†

ä¿®æ”¹å®Œæˆåï¼ŒçŠ¶æ€æ ç¬¬äºŒè¡Œåº”ä»ï¼š
```
[OMC] | session:12m | ğŸŸ¢ ~$0.0439 | 4.3k | Cache: 83.1% | $0.21/h | ultrawork | ctx:2%
```

å˜ä¸ºï¼š
```
session:12m | 4.3k | Cache: 83.1% | $0.21/h | ultrawork | ctx:2%
```
